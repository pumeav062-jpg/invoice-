import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, deleteDoc, updateDoc } from 'firebase/firestore';
import { 
  Plus, Trash2, Printer, Save, 
  Image as ImageIcon, Settings, QrCode, 
  CheckCircle2, RefreshCw, CloudOff, 
  Landmark, Globe, Type, LayoutGrid,
  History, Users, FileText, Download,
  TrendingUp, Clock, AlertCircle, Search,
  DollarSign
} from 'lucide-react';

// --- Firebase Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'invoice-os-v2';

const KHMER_FONTS = [
  { id: 'Kantumruy Pro', name: 'កន្ទុមរុយ' },
  { id: 'Moul', name: 'អក្សរមូល' },
  { id: 'Siemreap', name: 'សៀមរាប' },
  { id: 'Battambang', name: 'បាត់ដំបង' }
];

const STYLES = [
  { id: 'classic', name: 'Classic', color: '#1e293b' },
  { id: 'modern', name: 'Modern', color: '#2563eb' },
  { id: 'royal', name: 'Royal', color: '#854d0e' },
  { id: 'emerald', name: 'Emerald', color: '#059669' },
  { id: 'minimal', name: 'Minimal', color: '#000000' }
];

const INITIAL_INVOICE = {
  invoiceNumber: "INV-" + Date.now().toString().slice(-6),
  date: new Date().toISOString().split('T')[0],
  from: { name: "", address: "" },
  to: { name: "", address: "" },
  items: [{ description: "", quantity: 1, price: 0 }],
  notes: "ទំនិញដែលទិញហើយមិនអាចដូរវិញបានទេ។",
  logo: null,
  qrCode: null,
  themeColor: '#1e293b',
  styleId: 'classic',
  exchangeRate: 4100,
  mainCurrency: 'USD',
  fontFamily: 'Kantumruy Pro',
  status: 'Unpaid' 
};

export default function App() {
  const [user, setUser] = useState(null);
  const [lang, setLang] = useState('kh');
  const [view, setView] = useState('editor'); 
  const [invoice, setInvoice] = useState(INITIAL_INVOICE);
  const [history, setHistory] = useState([]);
  const [syncStatus, setSyncStatus] = useState('synced');
  
  const logoRef = useRef(null);
  const qrRef = useRef(null);

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const historyQuery = collection(db, 'artifacts', appId, 'users', user.uid, 'invoices');
    const unsubscribe = onSnapshot(historyQuery, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setHistory(data);
    });
    return () => unsubscribe();
  }, [user]);

  const saveInvoice = async () => {
    if (!user) return;
    setSyncStatus('syncing');
    try {
      const collRef = collection(db, 'artifacts', appId, 'users', user.uid, 'invoices');
      await addDoc(collRef, { ...invoice, createdAt: Date.now() });
      setSyncStatus('synced');
    } catch (err) { setSyncStatus('offline'); }
  };

  const deleteInvoice = async (id) => {
    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'invoices', id));
  };

  const updateItem = (index, field, value) => {
    const newItems = [...invoice.items];
    newItems[index][field] = field === 'description' ? value : Number(value);
    setInvoice({ ...invoice, items: newItems });
  };

  const total = invoice.items.reduce((acc, item) => acc + (item.quantity * item.price), 0);
  const formatCur = (val, cur) => cur === 'USD' ? `$ ${val.toLocaleString(undefined, { minimumFractionDigits: 2 })}` : `៛ ${Math.round(val).toLocaleString()}`;

  return (
    <div className={`min-h-screen bg-[#f8fafc] flex flex-col ${lang === 'kh' ? 'font-khmer' : 'font-sans'}`}>
      {/* Top Nav */}
      <nav className="bg-white border-b border-slate-200 px-6 py-3 flex items-center justify-between sticky top-0 z-50 no-print">
        <div className="flex items-center gap-6">
          <div className="flex items-center gap-2">
            <div className="bg-indigo-600 p-2 rounded-lg text-white"><FileText size={20}/></div>
            <span className="font-black text-slate-800 tracking-tighter">INVOICE OS</span>
          </div>
          <div className="flex gap-1 bg-slate-100 p-1 rounded-xl">
            <button onClick={() => setView('editor')} className={`px-4 py-1.5 rounded-lg text-[11px] font-bold transition ${view === 'editor' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>
              {lang === 'kh' ? 'កែសម្រួល' : 'Editor'}
            </button>
            <button onClick={() => setView('history')} className={`px-4 py-1.5 rounded-lg text-[11px] font-bold transition ${view === 'history' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>
              {lang === 'kh' ? 'ប្រវត្តិ' : 'History'}
            </button>
          </div>
        </div>
        <div className="flex items-center gap-3">
          <button onClick={() => setLang(lang === 'kh' ? 'en' : 'kh')} className="text-[11px] font-bold px-3 py-2 bg-slate-100 rounded-lg">
            {lang === 'kh' ? 'ENGLISH' : 'ភាសាខ្មែរ'}
          </button>
          <button onClick={saveInvoice} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-[11px] font-bold flex items-center gap-2">
            <Save size={14}/> {lang === 'kh' ? 'រក្សាទុក Cloud' : 'Save Cloud'}
          </button>
          <button onClick={() => window.print()} className="bg-slate-900 text-white p-2 rounded-lg"><Printer size={18}/></button>
        </div>
      </nav>

      <div className="flex-grow p-4 md:p-6 overflow-hidden">
        {view === 'editor' ? (
          <div className="grid grid-cols-12 gap-8 h-full">
            {/* Sidebar Editor */}
            <div className="col-span-12 xl:col-span-4 space-y-4 overflow-y-auto pr-2 no-print custom-scrollbar">
              <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 space-y-6">
                <h2 className="text-sm font-black text-slate-800 uppercase tracking-widest flex items-center gap-2 border-b pb-4">
                  <Settings size={16} className="text-indigo-500"/> {lang === 'kh' ? 'ការកំណត់វិក្កយបត្រ' : 'Settings'}
                </h2>

                {/* CURRENCY SELECTOR - ADDED BACK */}
                <div className="grid grid-cols-2 gap-4">
                   <div className="space-y-1">
                      <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter">{lang === 'kh' ? 'រូបិយប័ណ្ណ' : 'Currency'}</label>
                      <div className="flex bg-slate-100 p-1 rounded-xl">
                        <button onClick={() => setInvoice({...invoice, mainCurrency: 'USD'})} className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold transition ${invoice.mainCurrency === 'USD' ? 'bg-white shadow text-indigo-600' : 'text-slate-400'}`}>USD ($)</button>
                        <button onClick={() => setInvoice({...invoice, mainCurrency: 'KHR'})} className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold transition ${invoice.mainCurrency === 'KHR' ? 'bg-white shadow text-indigo-600' : 'text-slate-400'}`}>KHR (៛)</button>
                      </div>
                   </div>
                   <div className="space-y-1">
                      <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter">{lang === 'kh' ? 'អត្រាប្តូរប្រាក់' : 'Exchange Rate'}</label>
                      <input type="number" className="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-xs font-bold" value={invoice.exchangeRate} onChange={e => setInvoice({...invoice, exchangeRate: Number(e.target.value)})} />
                   </div>
                </div>

                <div className="grid grid-cols-2 gap-3">
                   <div className="space-y-1">
                      <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter">{lang === 'kh' ? 'ស្ថានភាព' : 'Status'}</label>
                      <select className="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-xs font-bold" value={invoice.status} onChange={e => setInvoice({...invoice, status: e.target.value})}>
                        <option value="Paid">Paid (បង់រួច)</option>
                        <option value="Unpaid">Unpaid (មិនទាន់បង់)</option>
                        <option value="Void">Void (មោឃៈ)</option>
                      </select>
                   </div>
                   <div className="space-y-1">
                      <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter">{lang === 'kh' ? 'Font ខ្មែរ' : 'Font'}</label>
                      <select className="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-xs font-bold" value={invoice.fontFamily} onChange={e => setInvoice({...invoice, fontFamily: e.target.value})}>
                        {KHMER_FONTS.map(f => <option key={f.id} value={f.id}>{f.name}</option>)}
                      </select>
                   </div>
                </div>

                <div className="space-y-3">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter">{lang === 'kh' ? 'អ្នកចេញវិក្កយបត្រ' : 'From'}</label>
                  <input className="w-full border rounded-xl p-2.5 text-xs font-bold" placeholder="ឈ្មោះក្រុមហ៊ុន" value={invoice.from.name} onChange={e => setInvoice({...invoice, from: {...invoice.from, name: e.target.value}})} />
                  <textarea className="w-full border rounded-xl p-2.5 text-xs h-16" placeholder="អាសយដ្ឋាន" value={invoice.from.address} onChange={e => setInvoice({...invoice, from: {...invoice.from, address: e.target.value}})} />
                </div>

                <div className="space-y-3">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter">{lang === 'kh' ? 'ផ្ញើជូនអតិថិជន' : 'Bill To'}</label>
                  <input className="w-full border rounded-xl p-2.5 text-xs font-bold" placeholder="ឈ្មោះអតិថិជន" value={invoice.to.name} onChange={e => setInvoice({...invoice, to: {...invoice.to, name: e.target.value}})} />
                  <textarea className="w-full border rounded-xl p-2.5 text-xs h-16" placeholder="អាសយដ្ឋានអតិថិជន" value={invoice.to.address} onChange={e => setInvoice({...invoice, to: {...invoice.to, address: e.target.value}})} />
                </div>

                <div className="space-y-3">
                  <div className="flex justify-between items-center">
                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter">{lang === 'kh' ? 'មុខទំនិញ' : 'Items'}</label>
                    <button onClick={() => setInvoice({...invoice, items: [...invoice.items, {description: "", quantity: 1, price: 0}]})} className="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100">+ {lang === 'kh' ? 'បន្ថែម' : 'Add'}</button>
                  </div>
                  {invoice.items.map((item, idx) => (
                    <div key={idx} className="flex gap-2 items-center bg-slate-50 p-2 rounded-xl">
                      <input className="flex-grow border-0 bg-transparent p-1 text-xs" placeholder="Description" value={item.description} onChange={e => updateItem(idx, 'description', e.target.value)} />
                      <input type="number" className="w-10 border-0 bg-transparent p-1 text-xs text-center font-bold" value={item.quantity} onChange={e => updateItem(idx, 'quantity', e.target.value)} />
                      <input type="number" className="w-20 border-0 bg-transparent p-1 text-xs text-right font-bold" value={item.price} onChange={e => updateItem(idx, 'price', e.target.value)} />
                      <button onClick={() => setInvoice({...invoice, items: invoice.items.filter((_, i) => i !== idx)})} className="text-slate-300 hover:text-red-500"><Trash2 size={14}/></button>
                    </div>
                  ))}
                </div>

                <div className="space-y-3 border-t pt-4">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Theme & Graphics</label>
                  <div className="flex items-center justify-between">
                     <div className="flex gap-2">
                        {STYLES.map(s => (
                          <button key={s.id} onClick={() => setInvoice({...invoice, styleId: s.id, themeColor: s.color})} className={`w-6 h-6 rounded-full border-2 transition ${invoice.styleId === s.id ? 'border-slate-900 scale-125' : 'border-transparent'}`} style={{backgroundColor: s.color}} />
                        ))}
                     </div>
                     <div className="flex gap-2">
                        <button title="Logo" onClick={() => logoRef.current.click()} className={`p-2 border rounded-xl transition ${invoice.logo ? 'bg-indigo-600 text-white' : 'bg-slate-50 text-slate-400'}`}><ImageIcon size={16}/></button>
                        <button title="QR Code" onClick={() => qrRef.current.click()} className={`p-2 border rounded-xl transition ${invoice.qrCode ? 'bg-indigo-600 text-white' : 'bg-slate-50 text-slate-400'}`}><QrCode size={16}/></button>
                     </div>
                  </div>
                  <input type="file" ref={logoRef} className="hidden" onChange={e => {
                    const r = new FileReader(); r.onload = () => setInvoice({...invoice, logo: r.result}); r.readAsDataURL(e.target.files[0]);
                  }} />
                  <input type="file" ref={qrRef} className="hidden" onChange={e => {
                    const r = new FileReader(); r.onload = () => setInvoice({...invoice, qrCode: r.result}); r.readAsDataURL(e.target.files[0]);
                  }} />
                </div>
              </div>
            </div>

            {/* Preview Section */}
            <div className="col-span-12 xl:col-span-8 flex justify-center overflow-y-auto h-full pb-20 custom-scrollbar">
               <div id="invoice-print" className="bg-white shadow-2xl w-full max-w-[800px] min-h-[1100px] p-16 flex flex-col relative overflow-hidden" style={{fontFamily: invoice.fontFamily}}>
                  {/* Design Accent */}
                  <div className="absolute top-0 right-0 w-64 h-64 bg-slate-50 rounded-full -mr-32 -mt-32 pointer-events-none"></div>
                  <div className="absolute top-0 left-0 w-full h-2" style={{backgroundColor: invoice.themeColor}}></div>

                  {/* Paid Stamp */}
                  {invoice.status === 'Paid' && (
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 border-[12px] border-green-500/10 text-green-500/10 text-9xl font-black rounded-full p-20 -rotate-12 pointer-events-none select-none z-0">PAID</div>
                  )}

                  <div className="flex justify-between items-start mb-16 relative z-10">
                    <div className="max-w-[50%]">
                      {invoice.logo ? <img src={invoice.logo} className="max-h-24 mb-6" /> : <div className="text-4xl font-black mb-6 tracking-tighter" style={{color: invoice.themeColor}}>BRAND</div>}
                      <h2 className="text-2xl font-black text-slate-900 leading-none mb-2">{invoice.from.name || 'ឈ្មោះអ្នកលក់'}</h2>
                      <p className="text-xs text-slate-400 whitespace-pre-line leading-relaxed">{invoice.from.address}</p>
                    </div>
                    <div className="text-right">
                      <h1 className="text-7xl font-black opacity-[0.03] uppercase tracking-tighter absolute top-10 right-10">Invoice</h1>
                      <div className="mt-4 space-y-4">
                        <div>
                          <p className="text-[10px] font-black text-slate-300 uppercase tracking-widest">Invoice Number</p>
                          <p className="font-black text-xl">#{invoice.invoiceNumber}</p>
                        </div>
                        <div>
                          <p className="text-[10px] font-black text-slate-300 uppercase tracking-widest">Date</p>
                          <p className="font-bold">{invoice.date}</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-8 mb-12 relative z-10">
                     <div className="p-10 rounded-[2.5rem] border border-slate-100 relative overflow-hidden" style={{backgroundColor: `${invoice.themeColor}05`}}>
                        <div className="absolute top-0 left-0 w-1.5 h-full" style={{backgroundColor: invoice.themeColor}}></div>
                        <h4 className="text-[10px] font-black text-indigo-600 uppercase tracking-widest mb-3">Bill To</h4>
                        <p className="text-3xl font-black text-slate-900 mb-1 leading-none">{invoice.to.name || 'ឈ្មោះអតិថិជន'}</p>
                        <p className="text-xs text-slate-500 leading-relaxed">{invoice.to.address}</p>
                     </div>
                     <div className="flex flex-col justify-center items-end pr-8">
                        <div className={`px-5 py-1.5 rounded-full text-[11px] font-black uppercase tracking-widest mb-4 ${invoice.status === 'Paid' ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'}`}>
                           {invoice.status}
                        </div>
                        <p className="text-[10px] font-black text-slate-300 uppercase tracking-widest mb-1">Exchange Rate</p>
                        <p className="text-xl font-black text-slate-800 tracking-tight">1$ = ៛ {invoice.exchangeRate.toLocaleString()}</p>
                     </div>
                  </div>

                  <div className="flex-grow relative z-10">
                    <table className="w-full">
                      <thead>
                        <tr className="border-b-2 border-slate-900">
                          <th className="py-4 text-left text-[10px] font-black uppercase text-slate-400">{lang === 'kh' ? 'បរិយាយមុខទំនិញ' : 'Description'}</th>
                          <th className="py-4 text-center text-[10px] font-black uppercase text-slate-400 w-24">{lang === 'kh' ? 'បរិមាណ' : 'Qty'}</th>
                          <th className="py-4 text-right text-[10px] font-black uppercase text-slate-400 w-32">{lang === 'kh' ? 'តម្លៃរាយ' : 'Price'}</th>
                          <th className="py-4 text-right text-[10px] font-black uppercase text-slate-900 w-40">{lang === 'kh' ? 'សរុប' : 'Subtotal'}</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-100">
                        {invoice.items.map((item, i) => (
                          <tr key={i}>
                            <td className="py-6 font-bold text-slate-800">{item.description || '...'}</td>
                            <td className="py-6 text-center text-slate-500">{item.quantity}</td>
                            <td className="py-6 text-right text-slate-500">{formatCur(item.price, invoice.mainCurrency)}</td>
                            <td className="py-6 text-right font-black text-slate-900">{formatCur(item.quantity * item.price, invoice.mainCurrency)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  <div className="mt-16 pt-10 border-t flex justify-between items-end relative z-10">
                    <div className="flex gap-12 items-end">
                      {invoice.qrCode && (
                        <div className="
